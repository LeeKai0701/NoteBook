## My MQTT

### 前言

上一章主要在剖析MQTT三方库的主体结构和内部流程，这一章开始分析MQTT自定义部分的内容，所以章节的名字改为My MQTT。重点主要集中在：适配Android平台的各种问题、自定义协议和设计参考这三方面。下文将分流程说明每个流程中需要注意的问题。

### 连接设计

#### 用户名密码

MQTT本质是为业务服务的，所以MQTT在连接包中的用户名、密码最好与业务有关联，即由用户体系提供登录时的账密，且尽量保证账密不要过于固定，避免无法区分是哪个用户的哪次登录正在连接MQTT操作智能设备，不利于安全和追踪问题。

最简单的办法就是使用uid作为用户名，然后session或者token等登录唯一凭证作为密码，然后使用与用户系统一致的鉴权方式。

#### ClientId和遗言

ClientId在同一个MQTT服务中，是不允许有重复的，所以必须保证每个客户端的ClientId都不相同，可以选择AndroidId、uuid、session等信息在的组合获得ClientId，而且最好能带上平台标识、包名等信息，同时也方便日志留痕。

#### MqttService与尽量保活策略

这个类是MQTT三方库中用来支持连接、数据收发的一个服务。但是其新版的源码，在启动服务的时候并没有启动一个前台服务，由于8.0后Android将不允许应用在后台启动后台服务，所以直接使用库将会导致MQTT连接成功概率大大降低，所以建议在使用时，对于8.0及以上系统直接启动前台服务。不过三方库也有考虑使用其他的方式尽量保持MQTT的连接，那就是在发送心跳包后会向系统电源管理系统申请锁屏后依旧给当前进程分配CPU资源的，使用的是WakeLock相关功能，源码是申请了10min的资源。

#### 重连

三方库MQTT连接回调中有connectionLost的状态回调，有这个回调就说明连接已经断开，需要再次重连，但是重连一定要注意一下策略：

1、应用在后台或者网络不可用时，断开后不要直接去重连，可尝试延迟30s后去重连，并且采用倍数退让的方式，建议最小间隔为1～2s

2、网络和APP状态均可用时，此时则可以直接使用倍数退让策略重连，尽快回复连接

3、由于倍数退让是有限度的，且APP退到后台后，很多厂商会在5min（小米手机更甚，可以让用户自己设置时间）后回收后台服务，所以有必须要对应用切到前台的行为进行监听，当应用到前台后检查连接状态并重新连接

应付了以上几点，基本就能保证较好的MQTT推送服务。

### 协议设计

这一部分是自定义协议的主体，操作的是publish和receive的payload，主要制定了传输内容的格式和加密方式，内容的格式可以选择Form表单的格式，也可以使用Json格式，主要看哪种形式比较方便解析；加密方式可自由设计，目的就是保证安全。

#### Topic设计

##### 纬度设计

topic跟业务是紧密相连的，所以每个topic分管哪些业务非常重要，下面就举个例子：公司A有主管B和实习生C、D，公司层面会经常公布一些消息，需要所有员工悉知；主管需要了解实习生每天的情况（日报）帮助成长，但这个事情并不用每个人都知道。所以在设计时，场景中的2类情况就应该划分2个topic处理，即：

```xml
【主管B】
订阅：
1、公司/B部门/实习生/#
2、公司/公告

【实习生C】
订阅：公司/公告
发日报：公司/B部门/实习生/小C

【实习生D】
订阅：公司/公告
发日报：公司/B部门/实习生/小D
```

如果把这2种事件都交给“公司/”这个topic处理可以做到吗？

其实是可以的，但是业务会设计的非常复杂，要处理非常多的业务逻辑和topic判断等问题

然后再举个反例，假定如下场景：新员工入职时需要让该部分所人有都知道，但是设计topic的时候，把入职事件划分到了员工纬度，比如：

```xml
公司/部门B/工号1/有人入职
公司/部门B/工号2/有人入职
```

这样就非常麻烦了，后台在接受到有人入职的信息后，要找到该入职人员的部门，在确认所有人的工号后给每个人都发一条推送，但是如果把有人入职的事件划分到部分B的纬度一切就变得简单起来。

所以在设计业务与Topic的时候一定要慎重考虑事件归属在哪个纬度比较合理

##### 双工设计

对于消息来说有推送和接收2个方向的数据，为了监听数据方便或者后台能灵活处理事务（非单纯转发），建议把设备端对后台服务的Topic分为/publish和/receive，云端在收到设备的/publish后可以选择性地给其他设备/receive的Topic推送数据，如果单个事件只有1个主题，最直接的问题就是自己发送的事件自己会收到。

#### 负载结构

**版本号：**版本号主要方便主要数据加密方式的升级，或者便于针对性的只支持部分版本数据。从功能上来看，版本号这个字段就必须是明文了，在Json和Form表单格式中均可以使用固定字段取值。如果是类似MQTT协议的格式，则可以把版本号放在固定的位置，给予固定的长度

**时间戳：**可以用来校验消息的时效性

**数据id：**可以使用uuid或者随机数作为产生源，一般是要组合时间戳来使用，防止重放同时也会设计到一些关于Qos的问题，下文会详细介绍

**正文：**正文就是当前topic传输的数据内容，建议不要直接明文传输

**样例：**

```json
{
	"version": "1.0",
	"time": 1556727327673,
	"dataId": "ac656ch2ggsd",
	"data": "xxx***xxx***"
}
```

要注意的是key字段可以短一些

### Qos与设计

#### 含义

首先说明一下每个Qos表示的含义

0：只发送1次，不管结果如果，有丢失

1：至少发送1次，当目标回执PUBACK时会停止下次发送

2：只发送1次且保证到达

#### 选用

##### 以下情况可选择 QoS0

- 一些不太重要的信息推送
- 定时上报的信息

##### 以下情况可选择 QoS2

- 消息消费方接收重复消息后会导致错误，例如步进设备

无特殊情况时一般选用Qos1，消耗较小且保证到达，但是对Qos1的选用也会造成一些小问题：概率性重收同一条消息

#### Qos1防重

为应对Qos1的重复消息，此前在设计payload结构时，其dataId和time字段就起到了非常重要的作用。我们可以针对某些重要的topic，以topic+time+dataId为key，time为value来缓存消息的时间戳，如果同一个key的消息重复推送了，就不再解析。对于这个缓存，可以设计一定的大小和阈值，满足一定阈值后清理缓存，这样可以使Qos1消息达到Qos2的效果，同时还能节省消息消耗。

### 安全设计

MQTT安全方面主要能依赖的还是3个方面，TSL/SSL证书校验（MQTT三方库自带），自定义协议的加密（自定义协议），加密参数安全和加密算法掩匿（app层面）。由于讲TSL/SSL的有很多文档和博客教如何使用这里就不说明了，同时app层面的东西设计到另外一个知识面，会在其他地方说明，这里也不多介绍。下面主要说明自定义协议如何处理安全问题，说明之前先来看满足安全需求的payload结构

```json
{
	"version": "1.0",
	"time": 1556727327673,
	"dataId": "ac656ch2ggsd",
  "sign":"asdsdas"
	"data": "xxx***xxx***"
}
```

#### 负载加密

在整个payload中，data部分是最重要的，其可以上报和下发信息，也就意味着其能控制设备，所以结构和格式一旦暴露整个控制体系的运作方式将直接透明化。对data的加密，可以仿造https安全套接层的方式，把密钥在登录时动态发给用户，等发送数据或者接收数据时再使用此密钥加解密即可。

这里需要注意的是加密的规则和加密的方式可以做一定程度的保护。

#### 负载校验

负载校验主要是通过sign字段，客户端和远端使用同样的规则生成sign，然后匹配sign是否一致，防止被他人篡改数据。
